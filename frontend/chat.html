<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat - Messages</title>
    <meta
      name="description"
      content="Send messages, connect with friends, and stay in touch with real-time chat."
    />

    <!-- Primary CSS -->
    <link rel="stylesheet" href="static/css/var.css"              fetchpriority="high" />
    <link rel="stylesheet" href="static/css/base/base.light.css"  fetchpriority="high" />
    <link rel="stylesheet" href="static/css/chat/chat.light.css"  fetchpriority="high" />

    <!-- Synchronous theme detection â€” runs before render to avoid flash -->
    <script>
      (function () {
        var t = localStorage.getItem('theme') ||
          (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', t);
        if (t === 'dark') {
          ['base', 'chat'].forEach(function (m) {
            var l = document.createElement('link');
            l.rel  = 'stylesheet';
            l.href = 'static/css/' + m + '/' + m + '.dark.css';
            l.fetchPriority = 'high';
            document.head.appendChild(l);
          });
        }
        var ld = function (v) {
          var e = document.getElementById('loading');
          if (e) e.style.display = v;
        };
        window.addEventListener('beforeunload', function () { ld('flex'); });
        window.addEventListener('load',         function () { ld('none'); });
        window.addEventListener('pageshow',     function (e) { if (e.persisted) ld('none'); });
      })();
    </script>

    <!-- Panel tabs, refresh button, and conversation modal styles -->
    <style>
      /* â”€â”€ Panel tabs â”€â”€ */
      .panel-tabs {
        display: flex;
        border-bottom: 1px solid var(--border);
        margin-bottom: var(--space-3);
      }
      .panel-tab {
        flex: 1;
        background: transparent;
        border: none;
        border-bottom: 2px solid transparent;
        padding: var(--space-2) var(--space-3);
        font-family: var(--font-sans);
        font-size: var(--text-sm);
        font-weight: 500;
        color: var(--fg-secondary);
        cursor: pointer;
        transition: all var(--transition-fast);
        margin-bottom: -1px;
      }
      .panel-tab.active {
        color: var(--accent);
        border-bottom-color: var(--accent);
      }
      .panel-tab:hover:not(.active) {
        color: var(--fg-primary);
        background: var(--hover);
      }

      /* â”€â”€ Refresh button â”€â”€ */
      .refresh-btn {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        color: var(--fg-secondary);
        cursor: pointer;
        font-size: var(--text-base);
        transition: all var(--transition-fast);
        flex-shrink: 0;
      }
      .refresh-btn:hover    { background: var(--hover); color: var(--fg-primary); }
      .refresh-btn:disabled { opacity: 0.5; cursor: not-allowed; }

      /* â”€â”€ Conversation modals â”€â”€ */
      .conv-modal-backdrop {
        position: fixed;
        inset: 0;
        background: var(--backdrop);
        z-index: var(--z-modal-backdrop);
        display: none;
        align-items: center;
        justify-content: center;
        padding: var(--space-4);
      }
      .conv-modal-backdrop.open { display: flex; }
      .conv-modal {
        background: var(--bg-primary);
        border: 1px solid var(--border);
        border-radius: var(--radius-xl);
        width: 100%;
        max-width: 400px;
        box-shadow: var(--shadow-xl);
        overflow: hidden;
      }
      .conv-modal-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-5) var(--space-6);
        border-bottom: 1px solid var(--border);
      }
      .conv-modal-title {
        font-weight: 600;
        font-size: var(--text-lg);
        color: var(--fg-primary);
      }
      .conv-modal-close {
        background: transparent;
        border: none;
        font-size: var(--text-xl);
        cursor: pointer;
        color: var(--fg-tertiary);
        line-height: 1;
        padding: 0 var(--space-1);
        transition: color var(--transition-fast);
      }
      .conv-modal-close:hover { color: var(--fg-primary); }
      .conv-modal-body { padding: var(--space-6); }
      .conv-modal-body p {
        font-size: var(--text-sm);
        color: var(--fg-secondary);
        margin-bottom: var(--space-5);
      }
      .conv-modal-error {
        font-size: var(--text-xs);
        color: var(--danger);
        margin-top: var(--space-2);
        min-height: 1rem;
      }
      .conv-modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: var(--space-3);
        padding: var(--space-4) var(--space-6);
        border-top: 1px solid var(--border);
        background: var(--bg-secondary);
      }
    </style>

    <!-- Preloads -->
    <link rel="preload" href="static/js/utils/theme.manager.js"    as="script" />
    <link rel="preload" href="static/js/config/platform.config.js" as="script" />
    <link rel="preload" href="static/js/utils/utils.js"            as="script" />
    <link rel="preload" href="non-static/chat/chat.state.js"        as="script" />
    <link rel="preload" href="non-static/chat/chat.ui.js"           as="script" />
    <link rel="preload" href="non-static/chat/chat.messages.js"     as="script" />
    <link rel="preload" href="non-static/chat/chat.conversations.js" as="script" />
    <link rel="preload" href="non-static/chat/chat.init.js"         as="script" />

    <!-- Scripts (deferred â€” execute after HTML is parsed, in order) -->
    <script defer src="static/js/utils/theme.manager.js"></script>
    <script defer src="static/js/config/platform.config.js"></script>
    <script defer src="static/js/utils/utils.js"></script>
    <script defer src="non-static/chat/chat.state.js"></script>
    <script defer src="non-static/chat/chat.ui.js"></script>
    <script defer src="non-static/chat/chat.messages.js"></script>
    <script defer src="non-static/chat/chat.conversations.js"></script>
    <script defer src="non-static/chat/chat.init.js"></script>
  </head>
  <body>
    <div id="loading">Loading...</div>

    <nav class="navbar">
      <a href="/chat" class="navbar-brand">
        <div class="navbar-logo">ðŸ’¬</div>
        <span>Chat</span>
      </a>
      <div class="navbar-menu">
        <a href="/chat" class="active">Messages</a>
      </div>
      <div class="navbar-end">
        <button class="btn btn-ghost btn-icon" id="themeToggle" title="Toggle theme">
          <img src="static/icons/icons/sun.svg" alt="Toggle theme" width="20" height="20" />
        </button>
        <a href="/settings" class="btn btn-ghost btn-icon" title="Settings">
          <img src="static/icons/icons/settings.svg" alt="Settings" width="20" height="20" />
        </a>
        <div class="avatar avatar-sm" id="userInitials">U</div>
      </div>
    </nav>

    <div class="chat-container">

      <!-- â”€â”€ Sidebar: conversation list â”€â”€ -->
      <aside class="conversations-panel">
        <div class="panel-header">
          <div class="panel-tabs">
            <button class="panel-tab active" data-tab="dm">Messages</button>
            <button class="panel-tab"        data-tab="groups">Groups</button>
          </div>
          <div class="panel-actions">
            <div class="search-box">
              <img
                src="static/icons/icons/search.svg"
                alt=""
                class="search-icon"
                width="16"
                height="16"
              />
              <input
                type="text"
                class="search-input"
                id="conversationSearch"
                placeholder="Search..."
              />
            </div>
            <button
              class="refresh-btn"
              id="refreshConvsBtn"
              title="Refresh"
              aria-label="Refresh conversations"
            >â†º</button>
            <button class="new-chat-btn" id="newChatBtn" title="New">+</button>
          </div>
        </div>
        <div class="conversations-list" id="conversationsList"></div>
      </aside>

      <!-- â”€â”€ Main: message area â”€â”€ -->
      <main class="chat-area">

        <!-- Shown when no conversation is selected -->
        <div id="emptyChatState" style="display: flex; flex: 1; align-items: center; justify-content: center;">
          <div style="text-align: center; color: var(--fg-tertiary);">
            <div style="font-size: 64px; margin-bottom: var(--space-4);">ðŸ’¬</div>
            <h2 style="color: var(--fg-secondary);">Select a conversation</h2>
            <p>Choose a conversation from the sidebar to start messaging</p>
          </div>
        </div>

        <!-- Shown when a conversation is active -->
        <div id="activeChatView" class="active-chat-view" style="display: none;">
          <div class="chat-header">
            <div class="chat-info">
              <div class="avatar" id="chatAvatar">U</div>
              <div class="chat-details">
                <div class="chat-name"   id="chatName">User</div>
                <div class="chat-status">
                  <span class="status-dot" id="statusDot"></span>
                  <span id="statusText">Offline</span>
                </div>
              </div>
            </div>
            <div class="chat-actions">
              <!-- Only visible for group conversations -->
              <button class="chat-action-btn" id="addMemberBtn" title="Add member" style="display:none;">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                  <circle cx="9" cy="7" r="4"/>
                  <line x1="19" y1="8" x2="19" y2="14"/>
                  <line x1="16" y1="11" x2="22" y2="11"/>
                </svg>
              </button>
              <button class="chat-action-btn" id="voiceCallBtn" title="Voice call">
                <img src="static/icons/icons/phone.svg" alt="Voice call" width="20" height="20" />
              </button>
              <button class="chat-action-btn" id="videoCallBtn" title="Video call">
                <img src="static/icons/icons/video.svg" alt="Video call" width="20" height="20" />
              </button>
            </div>
          </div>

          <div class="messages-container" id="messagesContainer"></div>

          <div class="message-input-area">
            <div class="input-tools">
              <button class="input-tool-btn" id="attachFileBtn" title="Attach file">
                <img src="static/icons/icons/paperclip.svg" alt="Attach file" width="20" height="20" />
              </button>
            </div>
            <div class="message-input-wrapper">
              <textarea
                class="message-input"
                id="messageInput"
                placeholder="Type a message..."
                rows="1"
              ></textarea>
              <button class="send-btn" id="sendBtn" disabled>
                <img src="static/icons/icons/send.svg" alt="Send" width="20" height="20" />
              </button>
            </div>
          </div>
        </div>

      </main>
    </div>

    <!-- â”€â”€ Modal: New Direct Message â”€â”€ -->
    <div class="conv-modal-backdrop" id="new-dm-modal">
      <div class="conv-modal">
        <div class="conv-modal-head">
          <span class="conv-modal-title">New Message</span>
          <button
            class="conv-modal-close"
            data-close-conv-modal="new-dm-modal"
            aria-label="Close"
          >Ã—</button>
        </div>
        <div class="conv-modal-body">
          <p>Start a new direct message conversation.</p>
          <div class="form-group">
            <label class="form-label" for="dmRecipientInput">Name or username</label>
            <input
              type="text"
              class="form-input"
              id="dmRecipientInput"
              placeholder="e.g. jane_doe"
              autocomplete="off"
            />
            <div class="conv-modal-error" id="dmRecipientError"></div>
          </div>
        </div>
        <div class="conv-modal-footer">
          <button class="btn btn-secondary btn-sm" data-close-conv-modal="new-dm-modal">Cancel</button>
          <button class="btn btn-primary btn-sm"   id="newDmSubmitBtn">Start Chat</button>
        </div>
      </div>
    </div>

    <!-- â”€â”€ Modal: New Group â”€â”€ -->
    <div class="conv-modal-backdrop" id="new-group-modal">
      <div class="conv-modal">
        <div class="conv-modal-head">
          <span class="conv-modal-title">New Group</span>
          <button
            class="conv-modal-close"
            data-close-conv-modal="new-group-modal"
            aria-label="Close"
          >Ã—</button>
        </div>
        <div class="conv-modal-body">
          <p>Create a new group conversation.</p>
          <div class="form-group">
            <label class="form-label" for="groupNameInput">Group name</label>
            <input
              type="text"
              class="form-input"
              id="groupNameInput"
              placeholder="e.g. Team Updates"
              autocomplete="off"
            />
            <div class="conv-modal-error" id="groupNameError"></div>
          </div>
        </div>
        <div class="conv-modal-footer">
          <button class="btn btn-secondary btn-sm" data-close-conv-modal="new-group-modal">Cancel</button>
          <button class="btn btn-primary btn-sm"   id="newGroupSubmitBtn">Create Group</button>
        </div>
      </div>
    </div>

  </body>
</html>

    <!-- â”€â”€ Modal: Add Group Member â”€â”€ -->
    <div class="conv-modal-backdrop" id="add-member-modal">
      <div class="conv-modal">
        <div class="conv-modal-head">
          <span class="conv-modal-title">Add Member</span>
          <button
            class="conv-modal-close"
            data-close-conv-modal="add-member-modal"
            aria-label="Close"
          >Ã—</button>
        </div>
        <div class="conv-modal-body">
          <p>Add someone to <strong id="addMemberGroupName"></strong>.</p>
          <div class="form-group">
            <label class="form-label" for="addMemberInput">Name or username</label>
            <input
              type="text"
              class="form-input"
              id="addMemberInput"
              placeholder="e.g. jane_doe"
              autocomplete="off"
            />
            <div class="conv-modal-error" id="addMemberError"></div>
          </div>
        </div>
        <div class="conv-modal-footer">
          <button class="btn btn-secondary btn-sm" data-close-conv-modal="add-member-modal">Cancel</button>
          <button class="btn btn-primary btn-sm"   id="addMemberSubmitBtn">Add Member</button>
        </div>
      </div>
    </div>

  </body>
</html>
